(function(){var $,TimeLine,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}};$=jQuery;TimeLine=function(){function TimeLine(div,options){var _ref,_ref1,_this=this;this.div=div;this.resize=__bind(this.resize,this);this.$div=$(this.div);this.canvas=document.createElement("canvas");this.div.appendChild(this.canvas);this.o=$.extend({fgColor:"#CFF09E",ptColor:"#3B8686",dragColor:"#79BD9A",minRegion:3e-6,ptRadius:10,tapTimeout:300,tapRadius:10},options);this.points=(_ref=options!=null?options.points:void 0)!=null?_ref:[];this.sortedPoints=this.points;this.visibleRegion=(_ref1=options!=null?options.visibleRegion:void 0)!=null?_ref1:[0,1];this.$=$(this.canvas);this.ctx=this.canvas.getContext("2d");this.dragging={};this.startPos={};this.startTime={};this.lastPos={};this.$.bind("mousedown",function(e){return _this.startDrag("mouse",e)});this.$.bind("mousewheel",function(e){var scale,scaleVal,scrollVal,_ref2;e.preventDefault();scaleVal=(_ref2=e.originalEvent.wheelDeltaY)!=null?_ref2:e.originalEvent.wheelDelta;scrollVal=e.originalEvent.wheelDeltaX;scale=Math.pow(1.001,scaleVal);_this.scale(scale,_this.visibleRegion,_this.screenToWorld(_this.eventToPoint(e))[0]);if(scrollVal!=null){return _this.scroll(scrollVal/2)}});this.canvas.ongesturestart=function(e){_this.gestureRegion=[_this.visibleRegion[0],_this.visibleRegion[1]];return _this.gestureBase=_this.screenToWorld(_this.eventToPoint(e))[0]};this.canvas.ongesturechange=function(e){if(Object.keys(_this.dragging).length){return}return _this.scale(e.scale,_this.gestureRegion,_this.gestureBase)};$(window).bind("mouseup",function(e){return _this.endDrag("mouse",e)});$(window).bind("mousemove",function(e){return _this.moveDrag("mouse",e)});this.canvas.ontouchstart=function(e){var t,_i,_len,_ref2,_results;_ref2=e.changedTouches;_results=[];for(_i=0,_len=_ref2.length;_i<_len;_i++){t=_ref2[_i];_results.push(_this.startDrag(t.identifier,t,e))}return _results};window.ontouchmove=function(e){var t,_i,_len,_ref2,_results;_ref2=e.changedTouches;_results=[];for(_i=0,_len=_ref2.length;_i<_len;_i++){t=_ref2[_i];_results.push(_this.moveDrag(t.identifier,t,e))}return _results};window.ontouchend=function(e){var t,_i,_len,_ref2,_results;_ref2=e.changedTouches;_results=[];for(_i=0,_len=_ref2.length;_i<_len;_i++){t=_ref2[_i];_results.push(_this.endDrag(t.identifier,t,e))}return _results};$(window).resize(function(){return _this.resize()});this.resize()}TimeLine.prototype.startDrag=function(tag,e,e2){var i,_ref;i=this.getIndexUnder(this.eventToPoint(e));if(i!=null){if(e2!=null){e2.preventDefault()}if(e2!=null){e2.stopPropagation()}this.dragging[tag]=i;this.points[i].dragging=tag;this.redraw()}this.startPos[tag]=this.eventToPoint(e);this.lastPos[tag]=this.startPos[tag];return this.startTime[tag]=(_ref=e.timeStamp)!=null?_ref:e2!=null?e2.timeStamp:void 0};TimeLine.prototype.getPoints=function(){return this.sortedPoints.slice()};TimeLine.prototype.setPoints=function(p){this.points=p;this.updateSorted(true);return this.redraw()};TimeLine.prototype.moveDrag=function(tag,e,e2){var p;if(this.dragging[tag]!=null){if(e2!=null){e2.preventDefault()}if(e2!=null){e2.stopPropagation()}this.points[this.dragging[tag]]=this.screenToWorld(this.eventToPoint(e));this.points[this.dragging[tag]].dragging=tag;this.updateSorted();return this.redraw()}else if(this.startPos[tag]!=null){if(e2!=null){e2.preventDefault()}if(e2!=null){e2.stopPropagation()}p=this.eventToPoint(e);this.scroll(this.lastPos[tag][0]-p[0]);return this.lastPos[tag]=p}};TimeLine.prototype.wasTap=function(tag,e,e2){var p,t,_ref;p=this.eventToPoint(e);t=(_ref=e.timeStamp)!=null?_ref:e2.timeStamp;return this.pointsWithin(p,this.startPos[tag],this.o.tapRadius)&&t-this.startTime[tag]<this.o.tapTimeout};TimeLine.prototype.endDrag=function(tag,e,e2){var wasTap;if(this.startPos[tag]==null){return}wasTap=this.wasTap(tag,e,e2);if(this.dragging[tag]!=null){if(e2!=null){e2.preventDefault()}if(wasTap){this.points.splice(this.dragging[tag],1);this.updateSorted()}else{delete this.points[this.dragging[tag]].dragging}delete this.dragging[tag];this.redraw()}else{if(wasTap){if(e2!=null){e2.preventDefault()}this.points.push(this.screenToWorld(this.eventToPoint(e)));this.updateSorted();this.redraw()}}delete this.startPos[tag];return delete this.startTime[tag]};TimeLine.prototype.scroll=function(dx){var unitsPerPixel,vRange;vRange=this.visibleRegion[1]-this.visibleRegion[0];unitsPerPixel=vRange/this.w;this.visibleRegion[0]+=unitsPerPixel*dx;this.visibleRegion[0]=Math.min(1-vRange,Math.max(0,this.visibleRegion[0]));this.visibleRegion[1]=this.visibleRegion[0]+vRange;return this.redraw()};TimeLine.prototype.scale=function(scale,origRegion,base){var diff,scaledRegion,t;diff=[origRegion[0]-base,origRegion[1]-base];scale=Math.min(scale,(diff[1]-diff[0])/this.o.minRegion);scaledRegion=[diff[0]/scale+base,diff[1]/scale+base];this.visibleRegion=function(){var _i,_len,_results;_results=[];for(_i=0,_len=scaledRegion.length;_i<_len;_i++){t=scaledRegion[_i];_results.push(Math.min(1,Math.max(0,t)))}return _results}();return this.redraw()};TimeLine.prototype.updateSorted=function(inhibit){this.sortedPoints=this.points.slice(0,this.points.length);this.sortedPoints.sort(function(a,b){return a[0]-b[0]});if(!inhibit){return this.$div.trigger("change")}};TimeLine.prototype.eventToPoint=function(e){var offset;offset=this.$.offset();return[e.pageX-offset.left,e.pageY-offset.top]};TimeLine.prototype.worldToScreen=function(pt){var xRatio;xRatio=(pt[0]-this.visibleRegion[0])/(this.visibleRegion[1]-this.visibleRegion[0]);return[xRatio*this.w,this.h-this.h*pt[1]]};TimeLine.prototype.screenToWorld=function(pt){var t,xPos,_i,_len,_ref,_results;xPos=pt[0]/this.w*(this.visibleRegion[1]-this.visibleRegion[0])+this.visibleRegion[0];_ref=[xPos,(this.h-pt[1])/this.h];_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){t=_ref[_i];_results.push(Math.min(1,Math.max(t,0)))}return _results};TimeLine.prototype.pointDistanceSq=function(p1,p2){var d;d=[p1[0]-p2[0],p1[1]-p2[1]];return d[0]*d[0]+d[1]*d[1]};TimeLine.prototype.pointsWithin=function(p1,p2,r){return this.pointDistanceSq(p1,p2)<r*r};TimeLine.prototype.getIndexUnder=function(pt){var i,w,_i,_ref;for(i=_i=0,_ref=this.points.length;0<=_ref?_i<_ref:_i>_ref;i=0<=_ref?++_i:--_i){w=this.worldToScreen(this.points[i]);if(this.pointsWithin(w,pt,this.o.ptRadius)){return i}}return null};TimeLine.prototype.handleCreateDelete=function(pt){var i;i=this.getIndexUnder(pt);if(i!=null){this.points.splice(i,1)}else{this.points.push(this.screenToWorld(pt))}this.updateSorted();return this.redraw()};TimeLine.prototype.resize=function(w,h){var r,_ref;if(w!=null){this.$div.width(w)}if(h!=null){this.$div.height(h)}this.w=this.$div.width();this.h=this.$div.height();r=(_ref=window.devicePixelRatio)!=null?_ref:1;this.canvas.width=r*this.w;this.canvas.height=r*this.h;this.$.css("width",this.w);this.$.css("height",this.h);this.ctx.setTransform(r,0,0,r,0,0);return this.redraw()};TimeLine.prototype.drawPoint=function(p){var sp;this.ctx.fillStyle=p.dragging!=null?this.o.dragColor:this.o.ptColor;sp=this.worldToScreen(p);this.ctx.beginPath();this.ctx.arc(sp[0],sp[1],this.o.ptRadius,0,2*Math.PI);return this.ctx.fill()};TimeLine.prototype.redraw=function(){var first,firstY,last,lastY,p,sp,_i,_j,_len,_len1,_ref,_ref1,_ref2,_ref3,_ref4,_ref5,_ref6,_ref7;this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);this.ctx.strokeStyle=this.o.fgColor;this.ctx.fillStyle=this.o.ptColor;_ref=this.points;for(_i=0,_len=_ref.length;_i<_len;_i++){p=_ref[_i];this.drawPoint(p)}lastY=(_ref1=(_ref2=this.sortedPoints)!=null?(_ref3=_ref2[this.sortedPoints.length-1])!=null?_ref3[1]:void 0:void 0)!=null?_ref1:.5;firstY=(_ref4=(_ref5=this.sortedPoints)!=null?(_ref6=_ref5[0])!=null?_ref6[1]:void 0:void 0)!=null?_ref4:.5;this.ctx.beginPath();first=this.worldToScreen([0,firstY]);this.ctx.moveTo(first[0],first[1]);_ref7=this.sortedPoints.slice(0);for(_j=0,_len1=_ref7.length;_j<_len1;_j++){p=_ref7[_j];sp=this.worldToScreen(p);this.ctx.lineTo(sp[0],sp[1])}last=this.worldToScreen([1,lastY]);this.ctx.lineTo(last[0],last[1]);return this.ctx.stroke()};return TimeLine}();$.fn.timeline=function(m){var a,found,methods,ret;a=arguments;ret=this;found=false;methods={init:function(o){var $t,t;$t=$(this);if($t.data("timeline")!=null){if(!found){ret=$t.data("timeline")}return found=true}else{if($t.is("div")){t=new TimeLine(this,o)}$t.data("timeline",t);if(!found){ret=t}return found=true}},resize:function(w,h){var t;t=$(this).data("timeline");if(t!=null){return t.resize(w,h)}}};this.each(function(){var args;if(methods[m]){args=Array.prototype.slice.call(a,1);return methods[m].apply(this,args)}else if(typeof m==="object"||m==null){return methods.init.apply(this,a)}else{return $.error("Method "+method+" does not exist on jQuery.timeline")}});return ret}}).call(this);